var fs=require("fs"),path=require("path"),express=require("express"),app=express(),index=require("./routes/index"),users=require("./routes/users"),resource=require("./routes/resource"),transaction=require("./routes/transaction"),library=require("./routes/library"),check=require("./routes/check"),about=require("./routes/about"),FileStreamRotator=require("file-stream-rotator"),logger=require("morgan"),logDirectory=path.join(__dirname,"log"),accessLogStream=FileStreamRotator.getStream({date_format:"YYYYMMDD",filename:path.join(logDirectory,"access-%DATE%.log"),frequency:"daily",verbose:!1}),favicon=require("serve-favicon"),session=require("express-session"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),mongoose=require("mongoose"),mongoDBConfig=require("./serverConfig/server/mongoBDConfig.json"),MongoStore=require("connect-mongo")(session);mongoose.Promise=global.Promise,app.set("views",path.join(__dirname,"views")),app.set("view engine","ejs"),mongoose.connect("mongodb://"+mongoDBConfig.user+":"+mongoDBConfig.password+"@"+mongoDBConfig.host+":"+mongoDBConfig.port+"/"+mongoDBConfig.database+"?authSource="+mongoDBConfig.authSource,{native_parser:!0}),mongoose.connection.on("error",console.error.bind(console,"连接数据库失败")),app.use(favicon(path.join(__dirname,"public","favicon.ico"))),app.use(logger("combined",{stream:accessLogStream})),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!1})),app.use(cookieParser()),app.use(express.static(path.join(__dirname,"public"))),app.use(session({key:"session",secret:"keboard cat",cookie:{maxAge:864e5},store:new MongoStore({db:"wms",mongooseConnection:mongoose.connection}),resave:!1,saveUninitialized:!0})),app.use(function(e,o,r){return/^.+\./.test(e.originalUrl)==e.originalUrl&&r(),e.session.user||"/users/login"==e.originalUrl?void r():o.redirect("/users/login")}),app.use("/",index),app.use("/users",users),app.use("/about",about),app.use("/resource",resource),app.use("/library",library),app.use("/check",check),app.use("/about",about),app.use(function(e,o,r){var s=new Error("Not Found");s.status=404,r(s)}),app.use(function(e,o,r){r.locals.message=e.message,r.locals.error="development"===o.app.get("env")?e:{},r.status(e.status||500),r.render("error/error")}),module.exports=app;