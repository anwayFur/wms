var express=require("express"),router=express.Router();router.param("_id",function(e,r,o,s){console.log("CALLED ONLY ONCE"+s),o()}),router.get("/",function(e,r){r.render("index",{title:"主页",user:e.session.user})}),router.get("/login",function(e,r){r.render("login",{title:"login"})}),router.post("/login",function(e,r){var o=e.body.email,s=e.body.password;User.findOne({username:o},function(o,t){if(o)return console.log(o),r.render("login",{title:"login"});if(t){var n=crypto.createHash("md5",secret).update(s).digest("hex");if(n===t.password){console.log("登陆成功！");var i=t;return i.password=null,delete i.password,e.session.user=i,r.redirect(e.body.url?e.body.url:"/")}return console.log("password erro！"+n),r.redirect("/login")}return console.log("用户名不存在！"),r.redirect("/login")})}),router.get("/logout",function(e,r){e.session.destroy(),r.redirect("/")}),router.get("/reg",function(e,r){r.render("register",{title:"login"})}),router.post("/reg",function(e,r){var o=e.body.email,s=e.body.password;User.findOne({username:o},function(t,n){if(t)return console.log(t),r.redirect("/reg");if(n)return console.log("用户名已经存在"),r.redirect("/reg");var i=crypto.createHash("md5",secret).update(s).digest("hex"),l=new User({username:o,password:i});l.save(function(o){return o?(console.log(o),r.redirect("/reg")):(console.log("注册成功！"),l.password=null,delete l.password,e.session.user=l,r.redirect("/"))})})}),module.exports=router;